---
title: "ClinLab_HW"
author: "Ekaterina Fokina"
date: "2022-10-24"
output: 
  html_document:
     keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(pROC)
library(gtsummary)
library(ggplot2)
```


# Прочитаем данные и посмотрим на общую информацию по ним

```{r}
diabetes <- read.csv("diabetes.csv")

summary(diabetes)
str(diabetes)

```

# Поработаем с количественными переменными

Заменим все нулевые значения в колонках Glucose, BloodPressure, SkinThickness, Insulin и BMI на NA как малосовместимые с жизнью.
Помимо этого, переведем значения глюкозы в более привычную для нас размерность ммоль/л.

```{r}

diabetes <- diabetes %>%
  mutate(across(c(Glucose, BloodPressure, SkinThickness, Insulin, BMI), ~ ifelse(.x == 0, NA, .x)),
         Glucose_mmol = round(Glucose / 18, 1),
         Glucose_mmol = as.numeric(Glucose_mmol),
         Outcome = ifelse(Outcome == 1, "Yes", "No"))

glimpse(diabetes)

```


# Вопрос №1

*Количество пациентов, которым можно выставить диагноз нарушение толерантности к глюкозе?*

<br>

*Количество пациентов без нарушения толерантности к глюкозе?*

<br>

```{r}

# Создадим вектор всех значений глюкозы в ммоль/л, за исключением пропущенных значений

diabetes_no_nas <- diabetes[complete.cases(diabetes$Glucose_mmol), ]$Glucose_mmol

# И посчитаем количество элементов, удовлетворяющих условиям

patients_with_diabetes <- length(diabetes_no_nas[diabetes_no_nas >= 7.8])
patients_with_diabetes

patients_without_diabetes <- length(diabetes_no_nas[diabetes_no_nas < 7.8])
patients_without_diabetes


```

Таким образом, если использовать в качестве порогового критерия уровень глюкозы >= 7.8 ммоль/л, то НТГ можно установить у **197** пациентов.
У **566** пациентов нарушения толерантности к глюкозе нет.

<br>

Посмотрим на сравнительную статистику групп с и без диабета

```{r}
diabetes%>% 
    tbl_summary(by = Outcome) %>% 
    add_p()
```


# Вопрос №2

*ROC-кривая для предсказания сахарного диабета по уровню гликемии*

```{r}
diabetes$Outcome = as.factor(diabetes$Outcome)

roc_curve <- roc(Outcome ~ Glucose_mmol, data = diabetes, ci = T)

roc_curve

ggroc(roc_curve) +
  theme_light()

```

# Вопрос №3

*Чему равна площадь под ROC-кривой?*

```{r}
roc_curve$auc
```

# Вопрос №4

*Чему равен 95% двусторонний доверительный интервал?*

```{r}
roc_curve$ci
```

# Вопрос №5

*Построить ROC-кривую и определить оптимальное значение инсулина для предсказания СД*

```{r}
roc_curve_ins <- roc(Outcome ~ Insulin, data = diabetes, ci = T)

roc_curve_ins

ggroc(roc_curve_ins) +
  theme_light()

# Определим наиболее оптимальное значение инсулина

roc_curve_ins %>% coords(x = "best", best.method = "closest.topleft")
```

Таким образом, оптимальным диагностическим критерием для предсказания СД является уровень инсулина *121 мкМЕ/мл*. Специфичность у такого критерия всего *0.62*, а чувствительность составляет *0.78*.

## Комментарии взыскующего автора

*Направление построения ROC-кривой может требовать обоснования. Критерием включения в исследования было отсутствие СД в анамнезе, и в датасете представлены только взрослые, а значит мы можем предположить, что преимущественно диагностироваться у них будет СД 2 типа, то есть инсулиннезависимый, реже - такие типы, как LADA. Помимо этого, по таблице, построенной в шестом чанке, видно, что уровень инсулина выше в группе с исходами. Поэтому направление кривой будет такое же, как и для глюкозы: мы ожидаем, что в группе исходов уровень инсулина выше, чем в контроле.*

# Вопрос №6

*Какая из количественных переменных обладает наибольшей площадью под ROC-кривой?*

*А какая - наименьшей?*

*И как это интерпретировать?*
```{r, message=FALSE}
diabetes %>% 
    pivot_longer(cols = !Outcome) %>% 
    group_by(name) %>% 
    summarise(AUC = roc(Outcome, value, ci = T)$ci[2] %>% round(3))
```

Наибольшая площадь под кривой наблюдается для переменной глюкоза, на втором месте - инсулин. Наименьшая площадь характерна для переменной наследственного фактора. Иными словами, глюкоза крови обладает наибольшей силой в качестве диагностического критерия СД. Значит именно это исследование мы можем предложить в качестве основного (или первичного) для диагностики заболевания.

Наименьшей предсказывающей силой обладает наследственность (что, кстати, стыкуется с нашим предположением о том, что у субъектов развивался СД2).